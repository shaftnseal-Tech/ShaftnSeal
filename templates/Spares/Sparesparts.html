{% extends 'base.html' %}
{% load static %}

{% block css %} 
{{block.super}}

<link rel="stylesheet" href="{% static 'Spares/css/sparesparts.css' %}" />

{% endblock css %} 
{% block content %}

<section class="tabledatasec">
<h4>Parts for   {{ model }} , {{ variant.discharge_diameter }}mm - {{variant.stages}} stages</h4>

 <!-- Modal Structure -->
 <div id="viewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background-color: rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
 
  <div style="position:relative; width:80%; height:90%; background:white; padding:20px;">
   
    <!-- Close Button -->
    <button onclick="closeModal()" style="position:absolute; top:10px; right:10px;
        background:none; border:none; font-size:24px; cursor:pointer;">
      <i class="fas fa-times"></i>
    </button>
 
    <!-- Iframe for Viewing -->
    <img id="modalImage" style="max-width: 100%; max-height: 90%;" />
   <div class="button-container">
  <button class="btn-custom" onclick="goToPreviousPage()">Back</button>
  <button class="btn-custom" onclick="goToNextPage()">Download</button>
</div>
  </div>
</div>
 
<form method="POST">
    {% csrf_token %}
    <div class="table-responsive">
        <div class="table-scroll">
        <table class="table table-bordered">
            <!-- Table content stays the same -->
            <thead>
                <tr>
                    <th>Part No</th>
                    <th>Name</th>
                    <th>Material</th>
                    <th>Technical Details</th>
                    <th>Drawing</th>
                    <th>CAD File</th>
                    <th>Mapping</th>
                    <th>Price</th>
                    <th>Available</th>
                </tr>
            </thead>
            <tbody>
                {% for part in parts_data %}
                <tr>
                    <td  data-label="Part No">{{ part.part_no }}</td>
                    <td data-label="Name">{{ part.name }}</td>
                    <td data-label="Material">
                        <select name="material_{{ part.part_no }}" class="material-select" data-part-no="{{ part.part_no }}">
                            <option value="" selected>Select material</option>
                            {% for material in part.materials %}
                                <option value="{{ material.material_name }}"
                                        data-price="{{ material.price }}"
                                        data-available="{{ material.available }}">
                                    {{ material.material_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td  data-label="Technical Details">
                        {% if part.technical_details %}
                            <a href="{{ part.technical_details }}" download title="Download">
                        <i class="fas fa-download"></i></a>
                        {% comment %} <a href="javascript:void(0);" onclick="openModal('{{ part.drawing }}')" title="View">
                                         <i class="fas fa-eye"></i>
                        </a> {% endcomment %}
                        <a href="javascript:void(0);"  onclick="openModal('{{ part.drawing }}')"  title="View">
                        <i class="fas fa-eye"></i> 
                        </a>

                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if part.drawing %}
                            <a href="{{ part.drawing }}" download title="Download"> <i class="fas fa-download"></i></a>
                        <a href="javascript:void(0);"  onclick="openModal('{{ part.drawing }}')"  title="View">
                        <i class="fas fa-eye"></i> 
                        </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if part.cad_file %}
                            <a href="{{ part.cad_file }}" download title="Download"> <i class="fas fa-download"></i></a>
                        <a href="javascript:void(0);"  onclick="openModal('{{ part.drawing }}')"  title="View">
                        <i class="fas fa-eye"></i> 
                        </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if part.mapping %}
                            <a href="{{ part.mapping }}" download title="Download"><i class="fas fa-download"></i></a></a>
                        {% comment %} <a href="javascript:void(0);" onclick="viewAndClose('{{ part.drawing  }}')" title="View">
                        <i class="fas fa-eye"></i> 
                        </a> {% endcomment %}
                         <a href="javascript:void(0);"  onclick="openModal('{{ part.drawing }}')"  title="View">
                        <i class="fas fa-eye"></i> 
                        </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-label="Price"><span class="price" id="price_{{ part.part_no }}"></span></td>
                    <td data-label="Available"><span class="available" id="available_{{ part.part_no }}"></span></td>
                    

                </tr>
                {% endfor %}
            </tbody>
    
        </table>
    </div>
    </div>
</form>

 </section
<!-- JavaScript to handle dynamic updates -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const materialSelects = document.querySelectorAll('.material-select');
 
        materialSelects.forEach(select => {
            select.addEventListener('change', function () {
                const partNo = this.getAttribute('data-part-no');
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.getAttribute('data-price') || '';
                const available = selectedOption.getAttribute('data-available') || '';
 
                // Update price and available quantity dynamically
                document.getElementById(`price_${partNo}`).textContent = price;
                document.getElementById(`available_${partNo}`).textContent = available;
            });
        });
    });

// modal img show//
    function openModal(url) {
    const modal = document.getElementById('viewModal');
    const image = document.getElementById('modalImage');

    const lowerUrl = url.toLowerCase();
    if (lowerUrl.endsWith('.jpg') || lowerUrl.endsWith('.jpeg') || lowerUrl.endsWith('.png')) {
        // Fetch and display
        fetch(url)
            .then(response => response.blob())
            .then(blob => {
                const blobUrl = URL.createObjectURL(blob);
                image.src = blobUrl;

                // Trigger download
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                modal.style.display = 'flex';
            })
            .catch(() => {
                alert("Failed to load image.");
            });
    } else {
        alert("Preview not available. Please download the file instead.");
    }
}
function closeModal() {
  document.getElementById('viewModal').style.display = 'none';
}



function viewAndClose(pdfUrl) {
        const newTab = window.open(pdfUrl, '_blank');

        setTimeout(() => {
            if (newTab) {
                newTab.close();
            }
        }, 10000); 
    }

</script>
{% endblock %}
 
 